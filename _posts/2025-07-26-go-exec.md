---
layout: post
title: exec.Command 与 os.StartProcess 有什么不一样
date: 2025-07-26
categories: Golang
---
exec.Command 与 os.StartProcess 有什么不一样

这是一个非常经典的问题：**exec.Command 和 os.StartProcess 都可以启动新进程，但功能和易用性完全不同**。我给你详细拆解一下：

---

## **1.**

## **os.StartProcess**

### **特点**

- Go 最底层的 **进程创建 API**，是对系统调用 fork + exec（类 Unix）或 CreateProcess（Windows）的直接封装。
- 调用麻烦，需要手动准备命令参数、环境变量、标准输入输出、文件描述符等。
- 返回 *os.Process，只能用它做简单的进程管理（等待、杀死）。

### **用法示例**

```
package main

import (
	"os"
	"syscall"
)

func main() {
	// argv 必须是完整路径 + 参数数组
	procAttr := &os.ProcAttr{
		Dir:   "",
		Env:   os.Environ(),
		Files: []*os.File{os.Stdin, os.Stdout, os.Stderr}, // 指定标准IO
		Sys:   &syscall.SysProcAttr{},
	}

	process, err := os.StartProcess("/bin/ls", []string{"ls", "-l"}, procAttr)
	if err != nil {
		panic(err)
	}
	process.Wait()
}
```

👉 缺点：调用复杂，几乎不做封装。

---

## **2.**

## **exec.Command**

### **特点**

- 在 os.StartProcess 之上做了 **更高级封装**，用起来更方便。
- 自动搜索 PATH（如果命令不是绝对路径）。
- 支持设置 Stdin、Stdout、Stderr，支持管道（cmd.StdoutPipe）。
- 提供了常用方法：Run()、Start()、Output()、CombinedOutput()。
- 默认会处理 shell 参数和环境变量，像写脚本一样简单。

### **用法示例**

```
package main

import (
	"fmt"
	"os/exec"
)

func main() {
	// 不需要写绝对路径，会自动查 PATH
	cmd := exec.Command("ls", "-l")

	// 一行拿到输出
	out, err := cmd.Output()
	if err != nil {
		panic(err)
	}
	fmt.Println(string(out))
}
```

👉 比 os.StartProcess 简洁很多。

---

## **3. 核心区别总结**

|**特性**|os.StartProcess|exec.Command|
|---|---|---|
|封装程度|最底层，直接调用系统 API|高级封装，集成常用功能|
|命令路径解析|需要绝对路径|自动按 PATH 查找|
|参数传递|必须手动组装 argv|直接传可变参数，自动处理|
|标准 IO|手动设置 ProcAttr.Files|简单设置 cmd.Stdin/Stdout|
|管道支持|不支持|支持（StdoutPipe、StderrPipe）|
|方法调用|只返回 Process|Run()、Output() 等更方便|

### **总结一句：**

- **os.StartProcess**：低级、原始、全手动，适合需要精确控制进程行为（文件描述符、权限）的场景。
- **exec.Command**：更高级封装，日常大多数场景都用它，除非你真的要完全控制底层。

---

## **4. 源码关系**

exec.Command 内部就是在组装好 argv、env、stdin/stdout 后，**最终调用 os.StartProcess** 来启动进程。

```
// exec.Command (简化)
func Command(name string, arg ...string) *Cmd {
    return &Cmd{
        Path: name,
        Args: append([]string{name}, arg...),
        // ...
    }
}
```

Cmd.Start() 里最后：

```
p, err := os.StartProcess(cmd.Path, cmd.Args, &os.ProcAttr{...})
```

---
